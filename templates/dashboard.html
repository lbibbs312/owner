{% extends "base.html" %}
{% block content %}
<div class="container fade-in" style="overflow-x:auto;">
  <h2 class="mt-4 mb-3">Driver Dashboard - Dynamic Selections</h2>

  <div class="row">
    <!-- Collapsible "Recent Tasks" card -->
    <div class="col-12 col-lg-6 mb-4">
      <div 
        class="card hover-card" 
        data-bs-toggle="collapse" 
        data-bs-target="#recentTasksCollapse"
        style="cursor: pointer;"
      >
        <div class="card-header bg-primary text-white">
          Recent Tasks
        </div>
        <div class="card-body">
          <p class="m-0">Click here to expand/collapse recent tasks assigned by manager.</p>
        </div>
      </div>

      <div class="collapse" id="recentTasksCollapse">
        <div class="card card-body">
          {% if tasks %}
            <ul class="list-group">
              {% for t in tasks %}
                <li class="list-group-item">
                  <div class="d-flex flex-column flex-md-row justify-content-between">
                    <div>
                      <strong>Task #{{ t.id }}</strong>: 
                      {{ t.title }} 
                      <span class="text-muted">({{ t.status }})</span>
                      <br>
                      <small class="text-secondary">
                        Created: {{ t.created_at.strftime('%Y-%m-%d') if t.created_at else '' }}
                      </small>
                    </div>
                    <div class="mt-2 mt-md-0">
                      <!-- Example live progress or status if you have a numeric progress -->
                      {% if t.progress is defined %}
                        <div class="progress" style="width:150px;">
                          <div 
                            class="progress-bar" 
                            role="progressbar" 
                            style="width: {{ t.progress }}%;" 
                            aria-valuenow="{{ t.progress }}" 
                            aria-valuemin="0" 
                            aria-valuemax="100"
                          >
                            {{ t.progress }}%
                          </div>
                        </div>
                      {% endif %}
                      <!-- If drivers can only 'view' but not 'edit': 
                           <a href="{{ url_for('view_task', task_id=t.id) }}" 
                              class="btn btn-info btn-sm">
                           View
                           </a>
                      -->
                      {% if current_user.role == "driver" %}
                        <!-- If driver is allowed to mark in-progress or something -->
                        <a href="{{ url_for('edit_task', task_id=t.id) }}"
                           class="btn btn-warning btn-sm ms-2">
                          Update
                        </a>
                      {% endif %}
                    </div>
                  </div>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p>No tasks found.</p>
          {% endif %}
          <!-- If you want to let drivers create tasks, uncomment:
          <a href="{{ url_for('create_task') }}" class="btn btn-success btn-sm mt-2">
            Create New Task
          </a>
          -->
        </div>
      </div>
    </div>

    <!-- Driver Logs card -->
    <div class="col-12 col-lg-6 mb-4">
      <div class="card">
        <div class="card-header bg-info text-white">
          Driver Logs
        </div>
        <div class="card-body">
          {% if logs %}
            <ul class="list-group">
              {% for log in logs %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <div>
                    <strong>Log #{{ log.id }}</strong> - {{ log.plant_name }}
                    {% if log.plant_name in PLANT_ADDRESSES %}
                      <br>
                      <small class="text-muted">
                        {{ PLANT_ADDRESSES[log.plant_name] }}
                      </small>
                    {% endif %}
                  </div>
                  <div>
                    <a href="{{ url_for('edit_driver_log', log_id=log.id) }}" 
                       class="btn btn-warning btn-sm me-1">
                      Edit
                    </a>
                    <a href="{{ url_for('view_driver_log', log_id=log.id) }}"
                       class="btn btn-info btn-sm">
                      View
                    </a>
                  </div>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p>No logs found.</p>
          {% endif %}
          <a href="{{ url_for('new_driving_log') }}" class="btn btn-success btn-sm mt-2">
            Create New Log
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- My PreTrips -->
  <div class="card mb-4">
    <!-- Example "cool" color for the header -->
    <div class="card-header text-white" style="background-color: #20c997;">
      My PreTrips
    </div>
    <div class="card-body">
      <a href="{{ url_for('new_pretrip') }}" class="btn btn-success btn-sm mb-2">
        Create New PreTrip
      </a>
      {% if pretrips %}
        <ul class="list-group">
          {% for p in pretrips %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <span>
                <strong>PreTrip #{{ p.id }}</strong> - {{ p.truck_name }}
              </span>
              <div>
                <a href="{{ url_for('view_pretrip', pretrip_id=p.id) }}" 
                   class="btn btn-info btn-sm me-2">
                  View
                </a>
                {% if not p.posttrip %}
                  <a href="{{ url_for('do_posttrip', pretrip_id=p.id) }}"
                     class="btn btn-danger btn-sm">
                    Complete PostTrip
                  </a>
                {% endif %}
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p>No PreTrips found.</p>
      {% endif %}
    </div>
  </div>

  <!-- End of Day Summary (optional) -->
  <div class="card mb-4">
    <div class="card-header bg-secondary text-white">
      End of Day Summary
    </div>
    <div class="card-body">
      {% if shift_start and shift_end %}
        <p><strong>Shift Start:</strong> {{ shift_start }}</p>
        <p><strong>Shift End:</strong> {{ shift_end }}</p>
        <p><strong>Total Hours:</strong> 
          {{ (shift_end - shift_start).total_seconds() / 3600 | round(2) }} hours
        </p>
        <a href="{{ url_for('end_of_day_summary') }}" class="btn btn-primary btn-sm">
          View Full Summary
        </a>
      {% else %}
        <p>No shift times recorded yet. Start or end a shift below.</p>
        <div class="mt-2">
          <a href="{{ url_for('start_shift') }}" class="btn btn-success btn-sm me-1">
            Start Shift
          </a>
          <a href="{{ url_for('end_shift') }}" class="btn btn-danger btn-sm">
            End Shift
          </a>
        </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
